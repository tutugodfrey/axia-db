<?php
class SetPaymentFusionData extends CakeMigration {

/**
 * Migration description
 *
 * @var string
 */
	public $description = 'set_payment_fusion_data';

	public $pfData = [
		['generic_product_mid' => '312996', 'merchant_mid' => '1239220055012356', 'standard_num_devices' => 9, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '266590', 'merchant_mid' => '1239220055004593', 'standard_num_devices' => 13, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '258605', 'merchant_mid' => '1239220055005269', 'standard_num_devices' => 9, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '295863', 'merchant_mid' => '295863', 'standard_num_devices' => 1, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '288381', 'merchant_mid' => '288381', 'standard_num_devices' => 48, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '287612', 'merchant_mid' => '1239220055005970', 'standard_num_devices' => 4, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '286935', 'merchant_mid' => '286935', 'standard_num_devices' => 69, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '304172', 'merchant_mid' => '304172', 'standard_num_devices' => 56, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '259366', 'merchant_mid' => '1239220055004098', 'standard_num_devices' => 69, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '283584', 'merchant_mid' => '283584', 'standard_num_devices' => 0, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 105, 'vp2pe_pfcc_num_devices' => 968],
		['generic_product_mid' => '316345', 'merchant_mid' => '316345', 'standard_num_devices' => 2, 'vp2pe_num_devices' => 219, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '306331', 'merchant_mid' => '306331', 'standard_num_devices' => 108, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '290821', 'merchant_mid' => '1239220055006697', 'standard_num_devices' => 0, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 213, 'vp2pe_pfcc_num_devices' => 454],
		['generic_product_mid' => '262276', 'merchant_mid' => '262276', 'standard_num_devices' => 410, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '266307', 'merchant_mid' => '1239220055004437', 'standard_num_devices' => 85, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '310045', 'merchant_mid' => '1239220055011481', 'standard_num_devices' => 14, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '317580', 'merchant_mid' => '317580', 'standard_num_devices' => 0, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 3, 'vp2pe_pfcc_num_devices' => 418],
		['generic_product_mid' => '290831', 'merchant_mid' => '1239220055006754', 'standard_num_devices' => 5, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '252729', 'merchant_mid' => '252729', 'standard_num_devices' => 55, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '280865', 'merchant_mid' => '1239220055005335', 'standard_num_devices' => 76, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '300078', 'merchant_mid' => '1239220055007703', 'standard_num_devices' => 18, 'vp2pe_num_devices' => 148, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '305205', 'merchant_mid' => '1239220055010137', 'standard_num_devices' => 0, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 205, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '262507', 'merchant_mid' => '1239220055004288', 'standard_num_devices' => 29, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '245547', 'merchant_mid' => '1239220055003082', 'standard_num_devices' => 53, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '313785', 'merchant_mid' => '313785', 'standard_num_devices' => 3, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '240433', 'merchant_mid' => '240433', 'standard_num_devices' => 99, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '240907', 'merchant_mid' => '240907', 'standard_num_devices' => 46, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '286179', 'merchant_mid' => '286179', 'standard_num_devices' => 5, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '234537', 'merchant_mid' => '1239220055001953', 'standard_num_devices' => 90, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '234965', 'merchant_mid' => '234965', 'standard_num_devices' => 176, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '236566', 'merchant_mid' => '236566', 'standard_num_devices' => 479, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '241816', 'merchant_mid' => '241816', 'standard_num_devices' => 200, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '243633', 'merchant_mid' => '243633', 'standard_num_devices' => 7, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '237326', 'merchant_mid' => '237326', 'standard_num_devices' => 293, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '293902', 'merchant_mid' => '293902', 'standard_num_devices' => 39, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '260568', 'merchant_mid' => '260568', 'standard_num_devices' => 39, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '257720', 'merchant_mid' => '257720', 'standard_num_devices' => 10, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '260476', 'merchant_mid' => '260476', 'standard_num_devices' => 53, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '270638', 'merchant_mid' => '270638', 'standard_num_devices' => 47, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '239321', 'merchant_mid' => '239321', 'standard_num_devices' => 81, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '245009', 'merchant_mid' => '1239220055003199', 'standard_num_devices' => 25, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '247334', 'merchant_mid' => '247334', 'standard_num_devices' => 20, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '195550', 'merchant_mid' => '195550', 'standard_num_devices' => 764, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '228597', 'merchant_mid' => '1239220055001730', 'standard_num_devices' => 159, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '322389', 'merchant_mid' => '322389', 'standard_num_devices' => 15, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '244968', 'merchant_mid' => '244968', 'standard_num_devices' => 18, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '255555', 'merchant_mid' => '255555', 'standard_num_devices' => 2405, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '278866', 'merchant_mid' => '278866', 'standard_num_devices' => 27, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '247883', 'merchant_mid' => '1239220055003397', 'standard_num_devices' => 91, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '313787', 'merchant_mid' => '313787', 'standard_num_devices' => 3, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '208723', 'merchant_mid' => '1239220055002571', 'standard_num_devices' => 33, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '261525', 'merchant_mid' => '261525', 'standard_num_devices' => 214, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '315220', 'merchant_mid' => '315220', 'standard_num_devices' => 206, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '262650', 'merchant_mid' => '262650', 'standard_num_devices' => 99, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '246424', 'merchant_mid' => '246424', 'standard_num_devices' => 7, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '272363', 'merchant_mid' => '272363', 'standard_num_devices' => 2, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '257109', 'merchant_mid' => '257109', 'standard_num_devices' => 3, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0],
		['generic_product_mid' => '323327', 'merchant_mid' => '1239220055016050', 'standard_num_devices' => 5, 'vp2pe_num_devices' => 0, 'pfcc_num_devices' => 0, 'vp2pe_pfcc_num_devices' => 0]
	];

/**
 * Actions to be performed
 *
 * @var array $migration
 */
	public $migration = array(
		'up' => array(
		),
		'down' => array(
		),
	);

/**
 * After migration callback
 *
 * @param string $direction Direction of migration process (up or down)
 * @return bool Should process continue
 * @throws Exception
 */
	public function after($direction) {
		if ($direction === 'up') {
			$Merchant = $this->generateModel('Merchant');
			$PaymentFusion = $this->generateModel('PaymentFusion');
			$ProductFeature = $this->generateModel('ProductFeature');
			$PaymentFusionsProductFeature = $this->generateModel('PaymentFusionsProductFeature');
			$features = $ProductFeature->find('list', [
				'fields' => ['feature_name', 'id'],
				'conditions' => ["products_services_type_id = (select id from products_services_types where products_services_description = 'Payment Fusion')"]
			]);

			foreach ($this->pfData as $data) {
				$pfFeatures = [];
				$merchantId = $Merchant->field('id', ['merchant_mid' => $data['merchant_mid']]);
				if ($merchantId) {
					unset($data['merchant_mid']);
					$pfId = $PaymentFusion->field('id', ['merchant_id' => $merchantId]);
					if ($pfId) {
						$data['id'] = $pfId;
					}
					$data['merchant_id'] = $merchantId;
					$data['standard_device_fee'] = 5;
					$data['vp2pe_device_fee'] = 9;
					$data['pfcc_device_fee'] = 9;
					$data['vp2pe_pfcc_device_fee'] = 11;
					$data['monthly_total'] = ($data['standard_num_devices'] * $data['standard_device_fee']) + ($data['vp2pe_num_devices'] * $data['vp2pe_device_fee']) + ($data['pfcc_num_devices'] * $data['pfcc_device_fee']) + ($data['vp2pe_pfcc_num_devices'] * $data['vp2pe_pfcc_device_fee']);
					$PaymentFusion->clear();
					if (!$PaymentFusion->save($data)) {
						throw new Exception('Failed to save payment fusion data');
					}
					$pfId = $PaymentFusion->id;
					if ($data['standard_num_devices'] > 0 && !$PaymentFusionsProductFeature->hasAny(["payment_fusion_id" => $pfId, "product_feature_id" => $features['Standard']])) {
						$pfFeatures[] = ["payment_fusion_id" => $pfId, "product_feature_id" => $features['Standard']];
					}
					if ($data['vp2pe_num_devices'] > 0 && !$PaymentFusionsProductFeature->hasAny(["payment_fusion_id" => $pfId, "product_feature_id" => $features['VP2PE']])) {
						$pfFeatures[] = ["payment_fusion_id" => $pfId, "product_feature_id" => $features['VP2PE']];
					}
					if ($data['pfcc_num_devices'] > 0 && !$PaymentFusionsProductFeature->hasAny(["payment_fusion_id" => $pfId, "product_feature_id" => $features['PFCC']])) {
						$pfFeatures[] = ["payment_fusion_id" => $pfId, "product_feature_id" => $features['PFCC']];
					}
					if ($data['vp2pe_pfcc_num_devices'] > 0 && !$PaymentFusionsProductFeature->hasAny(["payment_fusion_id" => $pfId, "product_feature_id" => $features['VP2PE & PFCC']])) {
						$pfFeatures[] = ["payment_fusion_id" => $pfId, "product_feature_id" => $features['VP2PE & PFCC']];
					}

					if (!empty($pfFeatures)) {
						//HABTM data structure
						if (!$PaymentFusionsProductFeature->saveMany($pfFeatures)) {
							throw new Exception('Failed to save HABTM PaymentFusionsProductFeature data');
						}
					}

				} else {
					echo ">>WARNING: Merchant {$data['merchant_mid']} does not exist, skipping.\n";
				}
			}
		}
		return true;
	}
}
