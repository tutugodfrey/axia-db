<?php
class UpdateMerchansAsBoardedInControlScan extends CakeMigration {

/**
 * Migration description
 *
 * @var string
 */
	public $description = 'update_merchans_as_boarded_in_control_scan';
/**
 * [$boadedMerchants 
 * List of Old merchant Mids or Merchant.merchant_id_old that where used to board merchants to controlscan in the past
 * @var [type]
 */
	public $boadedMerchants = ['7641110042408026','1239220055009261','1239220055009170','1239220055009279','1239220055009212','1239220055009386','1239220055009303','1239220055009352','1239220055009378','1239220055009394','1239220055011325','1239220055008644','1239220055010095','1239220055006143','1239220055008503','1239220055008560','1239220055008511','1239220055008594','1239220055008610','1239220055008578','1239220055008545','1239220055008529','1239220055008602','1239220055008636','1239220055008677','1239220055008859','1239220055008719','1239220055008842','1239220055008669','1239220055008875','1239220055008727','1239220055008800','1239220055008818','1239220055008735','1239220055008693','1239220055008701','1239220055008750','1239220055008685','1239220055008768','1239220055008784','1239220055008792','1239220055008776','1239220055008651','1239220055009402','7641110042409081','1239220055008016','7641110042408464','7641110042408297','7641110042408038','7641110042408029','7641110042408480','7641110042407964','7641110042408101','7641110042408237','7641110042408413','7641110042408425','7641110042408607','7641110042408616','7641110042408334','7641110042408896','1239220055009436','1239220055009527','1239220055009576','1239220055009618','1239220055009790','1239220055009782','1239220055007109','1239220055006556','1239220055010228','1239220055007661','1239220055007786','1239220055007836','1239220055008024','1239220055007976','1239220055008172','1239220055008362','1239220055008164','1239220055008404','1239220055008479','1239220055008487','1239220055008628','1239220055008834','1239220055008941','1239220055009006','1239220055009089','1239220055009162','1239220055009220','1239220055011051','1239220055006184','1239220055006580','1239220055005996','1239220055006200','1239220055006325','1239220055006051','1239220055006234','1239220055006176','1239220055006218','1239220055006432','1239220055006549','1239220055006291','1239220055006226','1239220055006473','1239220055006523','1239220055006416','1239220055006408','1239220055006499','1239220055006457','1239220055006481','1239220055006374','1239220055006390','1239220055006168','1239220055006283','1239220055006507','1239220055006333','1239220055006309','1239220055006028','1239220055006465','1239220055006259','1239220055006242','1239220055006366','1239220055006317','7641110042405633','1239220055010632','7641110042408056','7641110042408135','1239220055010202','1239220055010327','1239220055008107','1239220055009154','1239220055009287','1239220055009295','1239220055007547','1239220055011028','1239220055006150','1239220055006275','1239220055007521','1239220055007513','1239220055007505','1239220055007471','1239220055007539','1239220055009949','1239220055010418','1239220055010301','1239220055010319','1239220055010244','1239220055006754','1239220055006531','1239220055006978','7641110042408022','7641110042408031','7641110042408036','7641110042408246','7641110042408027','7641110042408030','7641110042407963','1239220055010053','7641110042408463','7641110042408111','7641110042408024','1239220055007604','7641110042408510','7641110042407736','1239220055009907','1239220055010798','1239220055006796','7641110042408651','1239220055009956','1239220055010780','7641110042409464','1239220055010590','1239220055010996','1239220055011333','7641110042407354','7641110042409022','1239220055010434','1239220055007117','7641110042408219','7641110042408456','7641110042408944','1239220055010376','1239220055005525','1239220055007463','1239220055006036','7641110042408039','7641110042408231','7641110042408301','7641110042407970','7641110042408443','7641110042408379','1239220055010004','1239220055011317','1239220055010236','1239220055009774','1239220055009766','1239220055009758','1239220055009741','1239220055009733','1239220055009725','1239220055009717','1239220055009709','1239220055009691','1239220055009675','1239220055009667','1239220055009659','1239220055010830','1239220055010863','7641110042408788','7641110042407664','7641110042408296','1239220055009642','1239220055009626','7641110042409465','1239220055009584','7641110042408236','1239220055009600','1239220055009592','1239220055009568','1239220055009550','1239220055011010','7641110042408337','7641110042408336','7641110042408335','7641110042408333','7641110042408332','1239220055009543','1239220055009535','1239220055009519','1239220055009501','1239220055009493','1239220055009485','7641110042408104','1239220055010988','7641110042407803','1239220055009477','1239220055009972','1239220055010921','1239220055009923','1239220055009915','1239220055006879','7641110042407709','7641110042407708','516618040010001','849420000230263','7641110042408390','1239220055010483','7641110042408468','1239220055010970','7641110042408028','1239220055010491','1239220055010772','1239220055010889','1239220055010897','1239220055010392','1239220055010905','1239220055010442','1239220055010467','1239220055010459','1239220055010400','1239220055010046','1239220055006960','1239220055006986','7641110042409475','1239220055005467','7641110042409164','7641110042409245','1239220055005392','7641110042409260','7641110042408736','7641110042408700','7641110042408894','7641110042408298','7641110042408240','7641110042408230','7641110042407971','7641110042408055','7641110042408049','7641110042407680','7641110042406194','7641110042406002','7641110042406272','1239220055006440','1239220055006424','1239220055006382','1239220055006341','1239220055006267','1239220055006192','1239220055006135','1239220055006127','1239220055006119','1239220055006101','1239220055006093','1239220055006085','1239220055006077','1239220055006069','1239220055006044','1239220055006010','1239220055006002','1239220055005988','1239220055005970','1239220055005962','1239220055005954','1239220055010954','1239220055010947','7641110042408093','1239220055007026','1239220055007018','1239220055005806','1239220055005798','1239220055009428','1239220055009410','1239220055009360','1239220055009345','1239220055009337','1239220055009329','1239220055009311','1239220055009253','1239220055009246','1239220055009238','1239220055009204','1239220055009196','1239220055009188','1239220055009147','1239220055009139','1239220055009121','1239220055009113','1239220055009105','1239220055009097','1239220055009071','1239220055009063','1239220055009055','1239220055009048','1239220055009030','1239220055009022','1239220055009014','1239220055008990','1239220055008982','1239220055008974','1239220055008966','1239220055008958','1239220055008933','1239220055008925','1239220055008917','1239220055008909','1239220055008891','1239220055008883','1239220055008826','1239220055008867','1239220055008743','1239220055008586','1239220055008495','1239220055008461','1239220055008453','1239220055008446','1239220055008438','1239220055008420','1239220055008412','1239220055008396','1239220055008370','1239220055008354','1239220055008347','1239220055008339','1239220055008321','1239220055008313','1239220055008305','1239220055008297','1239220055008289','1239220055008271','1239220055008263','1239220055008255','1239220055008248','1239220055008230','1239220055008206','1239220055008180','1239220055008156','1239220055008149','1239220055008131','1239220055008123','1239220055008115','1239220055008099','1239220055008081','1239220055008073','1239220055008065','1239220055008057','1239220055008040','1239220055008032','1239220055008008','1239220055007992','1239220055007984','1239220055007968','1239220055007943','1239220055007935','1239220055007927','1239220055007919','1239220055007901','1239220055007950','1239220055007893','1239220055007885','1239220055007877','1239220055007869','1239220055007851','1239220055007844','1239220055007828','1239220055007810','1239220055007802','1239220055007794','1239220055007778','1239220055007760','1239220055007752','1239220055007745','1239220055007737','1239220055007729','1239220055007711','1239220055007703','1239220055007695','1239220055007687','1239220055007679','1239220055007653','1239220055007646','1239220055007638','7641110042409292','7641110042408998','7641110042408996','7641110042408987','1239220055006358','1239220055008388','7641110042408103','1239220055010087','1239220055006515','1239220055010020','1239220055006648','7641110042409141','7641110042408606','1239220055007562','1239220055007554','1239220055010384','1239220055007620','1239220055007455','849420000192034','7641110042407810','7641110042408102','1239220055007612','7641110042408086','1239220055007497','1239220055007489','1239220055006747','1239220055007281','1239220055006671','1239220055010335','1239220055010277','1239220055010269','1239220055007265','1239220055007059','1239220055007042','1239220055007257','7641110042408427','1239220055006739','7641110042408426','1239220055010038','7641110042407702','1239220055006911','1239220055010079','1239220055006804','7641110042408525','7641110042408393','7641110042408292','7641110042408221','849420000182142','849420000179486','849420000179239','7641110042407997','7641110042407734','7641110042407707','7641110042408134','7641110042408295','7641110042408249','7641110042408218','7641110042408037','7641110042408033','7641110042408032','7641110042408023','7641110042408040','1239220055010194','7641110042408328','7641110042408338','7641110042408325','7641110042408330','7641110042408329','7641110042408327','7641110042408326','7641110042408324','7641110042408239','7641110042408238','7641110042408234','7641110042408233','7641110042408232','1239220055010475','1239220055010806','1239220055010814','1239220055010822','1239220055010962','1239220055010848','1239220055010871','1239220055010608','1239220055010764','1239220055010699','1239220055010707','1239220055010715','1239220055010533','1239220055010541','1239220055010368','1239220055010582','1239220055010509','1239220055010517','1239220055010558','1239220055010574','7641110042408235','7641110042408331','1239220055010251','1239220055006622','1239220055007125','1239220055007091','7641110042409103','1239220055008552'];

/**
 * Actions to be performed
 *
 * @var array $migration
 */
	public $migration = array(
		'up' => array(
		),
		'down' => array(
		),
	);

/**
 * Before migration callback
 *
 * @param string $direction Direction of migration process (up or down)
 * @return bool Should process continue
 */
	public function before($direction) {
		return true;
	}

/**
 * After migration callback
 *
 * @param string $direction Direction of migration process (up or down)
 * @return bool Should process continue
 */
	public function after($direction) {
		if ($direction == 'up') {
			$MerchantPci = $this->generateModel('MerchantPci');
			$Merchant = $this->generateModel('Merchant');
			$updates = [];
			
			foreach ($this->boadedMerchants as $oldMid) {
				$merch = $Merchant->find('first',[
					'fields' => ['id', 'merchant_mid', 'merchant_id_old'],
					'conditions' => [
						'OR' => [
							['merchant_id_old' => $oldMid],
							['merchant_mid' => $oldMid]
						]
					]
				]);
				$newData = [
					'merchant_id' => $merch['Merchant']['id'],
					'merchant_id_old' => $oldMid,
					'compliance_level' => 4,
					'scanning_company' => 'Control Scan',
					'insurance_fee' => 0,
					'pci_enabled' => false,
					'controlscan_boarded' => true,
					'cancelled_controlscan' => false
				];
				$toUpdate = $MerchantPci->find('first', ['conditions' => ['merchant_id' =>  $merch['Merchant']['id']]]);
				if (empty(Hash::get($toUpdate, 'MerchantPci.id'))) {
					$updates[] = $newData;
				} else {
					$newData = array_merge($toUpdate['MerchantPci'], $newData);
					$updates[] = $newData;
				}
			}

			$savedAll = $MerchantPci->saveMany($updates);
			if (!$savedAll) {
			 	throw new Exception('Failed to saveAll');
			}
		}
		return true;
	}
}
